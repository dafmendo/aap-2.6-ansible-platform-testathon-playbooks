---
- name: TC-USER-ORG-ASSOC-001 - Associate a user to organization via org-scoped role
  hosts: localhost
  gather_facts: false
  vars_files:
    - ./vars/aap.yml
    - ./vars/user.yml
    
  vars:
    org_name: "ENG-ORG-{{ rh_username }}"
    org_role: "Organization Auditor"     # or Organization Admin / Organization Viewer

  tasks:
    # Pre-req checks per spec
    - name: Verify organization exists
      vars:
        found_orgs: >-
          {{ lookup('ansible.platform.gateway_api', 'organizations',
                    query_params={'name': org_name}) | default([], true) }}
      ansible.builtin.assert:
        that:
          - found_orgs | length == 1
        fail_msg: "Organization '{{ org_name }}' not found."

    - name: Verify user exists
      vars:
        found_users: >-
          {{ lookup('ansible.platform.gateway_api', 'users',
                    query_params={'username': username}) | default([], true) }}
      ansible.builtin.assert:
        that:
          - found_users | length == 1
        fail_msg: "User '{{ username }}' not found. Run 1487-3-5 first or set 'username' var."

    # Assign org-scoped role to associate user with org
    - name: Associate user to org via role assignment
      ansible.platform.role_user_assignment:
        aap_hostname: "{{ aap_hostname }}"
        aap_username: "{{ aap_username }}"
        aap_password: "{{ aap_password }}"
        aap_validate_certs: "{{ aap_validate_certs }}"
        role_definition: "{{ org_role }}"
        user: "{{ username }}"
        object_ids:
          - "{{ org_name }}"
        state: present
      register: org_assoc

    - name: Assert first run changed
      ansible.builtin.assert:
        that: org_assoc is changed

    # Idempotency
    - name: Re-run association (idempotent)
      ansible.platform.role_user_assignment:
        aap_hostname: "{{ aap_hostname }}"
        aap_username: "{{ aap_username }}"
        aap_password: "{{ aap_password }}"
        aap_validate_certs: "{{ aap_validate_certs }}"
        role_definition: "{{ org_role }}"
        user: "{{ username }}"
        object_ids:
          - "{{ org_name }}"
        state: present
      register: org_assoc_again

    - name: Assert second run not changed
      ansible.builtin.assert:
        that: org_assoc_again is not changed
